# infra/images/worker/Containerfile
FROM nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    DEBIAN_FRONTEND=noninteractive

WORKDIR /app

# Install Python 3.11 and system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update && apt-get install -y --no-install-recommends \
    python3.11 \
    python3.11-dev \
    python3.11-distutils \
    python3-pip \
    build-essential \
    libpq-dev \
    libsndfile1 \
    ffmpeg \
    curl \
    git \
    wget \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Make python3.11 the default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1

# Upgrade pip
RUN python3 -m pip install --upgrade pip

# Copy and run download script for RVC models
COPY backend/scripts/download_rvc_models.sh /tmp/
RUN chmod +x /tmp/download_rvc_models.sh && \
    cd /app && /tmp/download_rvc_models.sh

# Clone RVC-WebUI and install dependencies
RUN git clone https://github.com/RVC-Project/Retrieval-based-Voice-Conversion-WebUI.git /app/rvc_webui && \
    cd /app/rvc_webui && \
    pip install -r requirements.txt

# ============================================================
# NEW: Download RVC pretrained models
# ============================================================
RUN mkdir -p /app/assets/pretrained_v2 && \
    cd /app/assets/pretrained_v2 && \
    wget -q https://huggingface.co/lj1995/VoiceConversionWebUI/resolve/main/pretrained_v2/f0D40k.pth && \
    wget -q https://huggingface.co/lj1995/VoiceConversionWebUI/resolve/main/pretrained_v2/f0G40k.pth && \
    wget -q https://huggingface.co/lj1995/VoiceConversionWebUI/resolve/main/pretrained_v2/f0D48k.pth && \
    wget -q https://huggingface.co/lj1995/VoiceConversionWebUI/resolve/main/pretrained_v2/f0G48k.pth

# Download HuBERT base model for feature extraction
RUN mkdir -p /app/assets/hubert && \
    cd /app/assets/hubert && \
    wget -q https://huggingface.co/lj1995/VoiceConversionWebUI/resolve/main/hubert_base.pt

# Create RVC working directories
RUN mkdir -p /app/rvc_webui/logs /app/rvc_webui/datasets
# ============================================================
# END NEW SECTION
# ============================================================

# Copy requirements and install Python dependencies
COPY backend/requirements.txt ./backend/requirements.txt
RUN pip install --no-cache-dir -r backend/requirements.txt

# Install PyTorch with CUDA 11.8 support (override requirements.txt versions)
RUN pip install --no-cache-dir --force-reinstall \
    torch==2.1.0+cu118 torchaudio==2.1.0+cu118 \
    --index-url https://download.pytorch.org/whl/cu118

# Install Chatterbox from working fork
RUN pip install --no-cache-dir "chatterbox-tts @ git+https://github.com/devnen/chatterbox-v2.git@master"

# Copy application code
COPY backend/ ./backend/
COPY tts_engine/ ./tts_engine/

# Add to PYTHONPATH
ENV PYTHONPATH=/app:/app/backend:/app/tts_engine:$PYTHONPATH

# Create non-root user and fix permissions
RUN useradd --create-home appuser && \
    chown -R appuser:appuser /app
USER appuser

# Set working directory to backend
WORKDIR /app/backend

# Run Celery worker
CMD ["celery", "-A", "parrotcore", "worker", "--loglevel=info"]